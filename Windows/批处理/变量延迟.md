<center><font size="8" color="#e9c341">变量延迟</font></center>

[TOC]



# 1 变量延迟的概念

## 1.1 cmd预处理

在cmd脚本处理的时候，为了加快解释速度，会有一个预处理的过程。例如：`echo %a%`，这么一条语句，在执行之前，cmd解释器就会去寻找，a的值是什么(例如是hello)，然后把命令`echo %a%`，直接替换为`echo hello`，这样的行为称之为：**变量扩展行为**。

cmd命令解释执行，是按照**从上到下，逐条命令**执行的(并不是逐行执行，一行并不一定是一条命令)

> 预处理的大致情形是这样的：首先，把一条完整的语句读入内存中（不管这条语句有多少行，它们都会被一起读入），然后，识别出哪些部分是命令关键字，哪些是开关、哪些是参数，哪些是变量引用……如果代码语法有误，则给出错误提示或退出批处理环境；如果顺利通过，接下来，就把该条语句中所有被引用的变量及变量两边的百分号对，用这条语句被读入内存之就已经赋予该变量的具体值来替换……当所有的预处理工作完成之后，批处理才会执行每条完整语句内部每个命令的原有功能。也就是说，如果命令语句中含有变量引用（变量及紧邻它左右的百分号对），并且某个变量的值在命令的执行过程中被改变了，即使该条语句内部的其他地方也用到了这个变量，也不会用最新的值去替换它们，因为某条语句在被预处理的时候，所有的变量引用都已经被替换成字符串常量了，变量值在复合语句内部被改变，不会作用到语句内部的其他任何地方。

## 1.2 变量延迟

请看下面的代码：

```bat
@echo off
set num=0&&echo %num%
pause
```

这个代码执行之前，会进行预处理，`echo %num%`命令中的`%num%`，会在真正执行之前，被替换成num的值，因为执行之前，num的值是空(第二行是复合语句，cmd解释器是不会执行复合语句的一部分来替换变量num的值的)，因此预处理之后的命令是：`set num=0&&echo `，因此打印出来的不是我们想要的结果。那有没有办法，不让cmd预处理器在命令执行之前就扩展变量呢？就是使用：变量延迟功能。

所谓变量延迟，**指的是让cmd把变量的扩展行为，延迟到真正执行命令的时候，再去替换变量的值，而不是提前在预处理阶段，就替换了一个可能错误的值。**

# 2 使用变量延迟

使用变量延迟的方式有两种：

- 使用setlocal enabledelayedexpansion
- 使用call语句

## 2.1 使用setlocal enabledelayedexpansion

```bat
@echo off
setlocal enabledelayedexpansion
set num=0&&echo !num!
pause
```

> **使用 setlocal enabledelayedexpansion 语句：在获取变化的变量值语句之前使用setlocal enabledelayedexpansion，并把原本使用百分号对闭合的变量引用改为使用感叹号对来闭合；**

## 2.2 使用call

```bat
@echo off
set num=0&&call echo %%num%%
pause
```

> **使用 call 语句：在原来命令的前部加上 call 命令，并把变量引用的单层百分号对改为双层。**